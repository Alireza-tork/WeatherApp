<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø§Ù¾ Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ Ø³Ø§Ø¯Ù‡</title>
  <style>
    :root{
      --bg:#0f1724;
      --card:#0b1220;
      --accent:#60a5fa;
      --glass: rgba(255,255,255,0.04);
      --text:#e6eef8;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      background:linear-gradient(180deg,#071022 0%, #0f1724 60%);
      color:var(--text);
      font-family:Inter, Roboto, "Helvetica Neue", Arial, sans-serif;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .app{
      width:100%;
      max-width:920px;
      background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border-radius:18px;
      padding:20px;
      box-shadow:0 10px 30px rgba(2,6,23,0.6);
      backdrop-filter: blur(6px);
    }
    header{
    display:flex;
    align-items:center;
    gap:16px;
    margin-bottom:12px;
    }
    header h1{
        font-size:20px;
        margin:0;
    }
    .controls{
        display:flex;
        gap:8px;
        align-items:center;
        margin-bottom:16px;
    }
    .search{
        flex:1;
        display:flex;
        gap:8px;
    }
    input[type=text]{
        flex:1;
        padding:10px 12px;
        border-radius:10px;
        border:1px solid rgba(255,255,255,0.06);
        background:transparent;
        color:var(--text);
        outline:none;
        font-size:15px;
    }
    button{
        padding:10px 12px;
        border-radius:10px;
        border:0;
        background:linear-gradient(90deg,var(--accent), #3b82f6);
        color:#021024;
        font-weight:600;
        cursor:pointer;
    }
    button.secondary{
        background:transparent;
        border:1px solid rgba(255,255,255,0.06);
        color:var(--text);
        font-weight:600;
    }
    .grid{
        display:grid;
        grid-template-columns:1fr 320px;
        gap:18px;
    }
    @media (max-width:880px){.grid{grid-template-columns:1fr} .controls{flex-direction:column} header{flex-direction:column;align-items:flex-start}}

    .main-card{
        background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
        padding:18px;
        border-radius:14px;
        border:1px solid rgba(255,255,255,0.03);
    }
    .current{
        display:flex;
        align-items:center;
        gap:18px;
    }
    .icon{
        width:110px;
        height:110px;
        border-radius:12px;
        background:var(--glass);
        display:flex;
        align-items:center;
        justify-content:center;
        font-size:42px;
    }
    .temp{
        font-size:46px;
        font-weight:700;
    }
    .meta{opacity:0.9}

    .side{
        display:flex;
        flex-direction:column;
        gap:12px;
    }
    .card{
        background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
        padding:12px;
        border-radius:12px;
        border:1px solid rgba(255,255,255,0.03);
    }
    .row{
        display:flex;
        justify-content:space-between;
        gap:8px;
    }
    .small{
        font-size:13px;
        opacity:0.9;
    }
    .footer{
        margin-top:12px;
        font-size:13px;
        opacity:0.7;
    }

    .loading{
        opacity:0.8;
        font-size:14px;
    }
    .error{
        color:#ff7a7a;
        font-weight:700;
    }

    /* simple animations */
    .pulse{animation:pulse 2s infinite}
    @keyframes pulse{0%{transform:translateY(0)}50%{transform:translateY(-3px)}100%{transform:translateY(0)}}
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Ø§Ù¾ Ù‡ÙˆØ§Ø´Ù†Ø§Ø³ÛŒ </h1>
      <div style="margin-inline-start:auto;color:rgba(255,255,255,0.6);font-size:13px">Ø¨Ø¯ÙˆÙ† Ù†ÛŒØ§Ø² Ø¨Ù‡ Ú©Ù„ÛŒØ¯ API â€” Ø§Ø² Open-Meteo Ùˆ Geocoding Ø±Ø§ÛŒÚ¯Ø§Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯</div>
    </header>

    <div class="controls">
      <div class="search">
        <input id="q" type="text" placeholder="Ù†Ø§Ù… Ø´Ù‡Ø± Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ØŒ Ù…Ø«Ù„Ø§: Tehran ÛŒØ§ London" />
        <button id="searchBtn">Ø¬Ø³ØªØ¬Ùˆ</button>
      </div>
      <button id="locBtn" class="secondary">Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù„ÙˆÚ©ÛŒØ´Ù† Ù…Ù†</button>
      <button id="refreshBtn" class="secondary">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button>
    </div>

    <div class="grid">
      <div class="main-card">
        <div id="status" class="loading">Ø¢Ù…Ø§Ø¯Ù‡. Ø´Ù‡Ø±ÛŒ Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø§Ø² Ù„ÙˆÚ©ÛŒØ´Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.</div>

        <div id="weatherUI" style="display:none;margin-top:12px">
          <div class="current">
            <div class="icon" id="icon">â˜€ï¸</div>
            <div>
              <div class="temp" id="temp">-- Â°C</div>
              <div class="meta" id="desc">--</div>
              <div class="small" id="place">--</div>
            </div>
          </div>

          <div style="margin-top:14px" class="row small">
            <div>Ø³Ø±Ø¹Øª Ø¨Ø§Ø¯: <span id="wind">-- m/s</span></div>
            <div>ÙØ´Ø§Ø±: <span id="pressure">-- hPa</span></div>
            <div>Ø¬Ù‡Øª: <span id="windDir">--</span></div>
          </div>

          <div style="margin-top:12px" class="row">
            <div class="small">Ø²Ù…Ø§Ù† Ø¢Ø®Ø±ÛŒÙ† Ø¯Ø§Ø¯Ù‡: <span id="time">--</span></div>
            <div class="small">Ù…Ù†Ø¨Ø¹: Open-Meteo</div>
          </div>
        </div>
      </div>

      <div class="side">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ±</div>
            <div class="small" id="coords">--</div>
          </div>
          <div style="margin-top:8px" class="small">Ù¾ÛŒØ´â€ŒØ¨ÛŒÙ†ÛŒ Ø³Ø§Ø¹ØªÛŒ Ùˆ ØªÙˆØ¶ÛŒØ­Ø§Øª Ú©Ø¯ Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
        </div>

        <div class="card">
          <div style="font-weight:700;margin-bottom:6px">Ø±Ø§Ù‡Ù†Ù…Ø§</div>
          <ul style="margin:0;padding-inline-start:18px;line-height:1.6;font-size:13px">
            <li>Ø´Ù‡Ø± Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯ Ùˆ Ø¯Ú©Ù…Ù‡ Â«Ø¬Ø³ØªØ¬ÙˆÂ» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯.</li>
            <li>ÛŒØ§ Â«Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù„ÙˆÚ©ÛŒØ´Ù† Ù…Ù†Â» Ø±Ø§ Ø¨Ø²Ù†ÛŒØ¯ ØªØ§ Ù…Ø±ÙˆØ±Ú¯Ø± Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´Ù…Ø§ Ø±Ø§ Ø¯Ø±ÛŒØ§ÙØª Ú©Ù†Ø¯.</li>
            <li>Ø¨Ø±Ù†Ø§Ù…Ù‡ Ø§Ø² Open-Meteo Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¢Ø¨ Ùˆ Ù‡ÙˆØ§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ â€” Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ú©Ù„ÛŒØ¯ API Ù†ÛŒØ³Øª*.</li>
          </ul>
        </div>

        <div class="card" id="debugCard" style="display:none">
          <div style="font-weight:700">Ø¯ÛŒØ¨Ø§Ú¯</div>
          <pre id="debug" style="white-space:pre-wrap;font-size:12px;opacity:0.85"></pre>
        </div>
      </div>
    </div>

  <script>
    // Helper: map Open-Meteo weathercode to emoji and description (ÙØ§Ø±Ø³ÛŒ)
    const weatherMap = {
      0: {icon:'â˜€ï¸', text:'ØµØ§Ù'},
      1: {icon:'ğŸŒ¤ï¸', text:'Ú©Ù…ÛŒ Ø§Ø¨Ø±ÛŒ'},
      2: {icon:'â›…', text:'Ø§Ø¨Ø±ÛŒ Ù¾Ø±Ø§Ú©Ù†Ø¯Ù‡'},
      3: {icon:'â˜ï¸', text:'Ø§Ø¨Ø±ÛŒ'},
      45: {icon:'ğŸŒ«ï¸', text:'Ù…Ù‡'},
      48: {icon:'ğŸŒ«ï¸', text:'Ù…Ù‡ ÛŒØ®â€ŒØ²Ø¯Ù‡'},
      51: {icon:'ğŸŒ¦ï¸', text:'Ø¨Ø§Ø±Ø§Ù† Ø±ÛŒØ²'},
      53: {icon:'ğŸŒ¦ï¸', text:'Ø¨Ø§Ø±Ø§Ù† Ø±ÛŒØ² Ù…ØªÙˆØ³Ø·'},
      55: {icon:'ğŸŒ§ï¸', text:'Ø¨Ø§Ø±Ø§Ù† Ø±ÛŒØ² Ø´Ø¯ÛŒØ¯'},
      56: {icon:'ğŸŒ§ï¸', text:'Ø¨Ø§Ø±Ø§Ù† ÛŒØ®â€ŒØ²Ø¯Ù‡ Ø±ÛŒØ²'},
      57: {icon:'ğŸŒ§ï¸', text:'Ø¨Ø§Ø±Ø§Ù† ÛŒØ®â€ŒØ²Ø¯Ù‡ Ø´Ø¯ÛŒØ¯'},
      61: {icon:'ğŸŒ§ï¸', text:'Ø¨Ø§Ø±Ø´ Ø¨Ø§Ø±Ø§Ù†'},
      63: {icon:'ğŸŒ§ï¸', text:'Ø¨Ø§Ø±Ø´ Ø¨Ø§Ø±Ø§Ù† Ù…ØªÙˆØ³Ø·'},
      65: {icon:'â›ˆï¸', text:'Ø¨Ø§Ø±Ø´ Ø¨Ø§Ø±Ø§Ù† Ø´Ø¯ÛŒØ¯'},
      71: {icon:'ğŸŒ¨ï¸', text:'Ø¨Ø§Ø±Ø´ Ø¨Ø±Ù'},
      73: {icon:'ğŸŒ¨ï¸', text:'Ø¨Ø§Ø±Ø´ Ø¨Ø±Ù Ù…ØªÙˆØ³Ø·'},
      75: {icon:'ğŸŒ¨ï¸', text:'Ø¨Ø§Ø±Ø´ Ø¨Ø±Ù Ø´Ø¯ÛŒØ¯'},
      80: {icon:'ğŸŒ¦ï¸', text:'Ø¨Ø§Ø±Ø´ Ù†Ø§Ù…Ù†Ø¸Ù…'},
      81: {icon:'ğŸŒ§ï¸', text:'Ø¨Ø§Ø±Ø´ Ù†Ø§Ù…Ù†Ø¸Ù…'},
      82: {icon:'â›ˆï¸', text:'Ø¨Ø§Ø±Ø´ Ù†Ø§Ù¾Ø§ÛŒØ¯Ø§Ø±'},
      95: {icon:'â›ˆï¸', text:'Ø±Ø¹Ø¯ Ùˆ Ø¨Ø±Ù‚'},
      96: {icon:'â›ˆï¸', text:'Ø±Ø¹Ø¯ Ùˆ Ø¨Ø±Ù‚ Ø¨Ø§ ØªÚ¯Ø±Ú¯ Ø®ÙÛŒÙ'},
      99: {icon:'â›ˆï¸', text:'Ø±Ø¹Ø¯ Ùˆ Ø¨Ø±Ù‚ Ø¨Ø§ ØªÚ¯Ø±Ú¯'}
    };
    console.log(weatherMap);
    
    const qInput = document.getElementById('q');
    const searchBtn = document.getElementById('searchBtn');
    const locBtn = document.getElementById('locBtn');
    const refreshBtn = document.getElementById('refreshBtn');
    const status = document.getElementById('status');
    const weatherUI = document.getElementById('weatherUI');

    const iconEl = document.getElementById('icon');
    const tempEl = document.getElementById('temp');
    const descEl = document.getElementById('desc');
    const placeEl = document.getElementById('place');
    const coordsEl = document.getElementById('coords');
    const windEl = document.getElementById('wind');
    const pressureEl = document.getElementById('pressure');
    const windDirEl = document.getElementById('windDir');
    const timeEl = document.getElementById('time');
    const debugCard = document.getElementById('debugCard');
    const debugPre = document.getElementById('debug');

    let lastPosition = null; 
    let lastResponse = null;

    function setStatus(s, err=false){
      status.textContent = s;
      status.className = err? 'error' : 'loading';
    }

    function mapWeather(code){
      return weatherMap[code] || {icon:'â“', text:'Ù†Ø§Ù…Ø´Ø®Øµ'};
    }

    function degToCompass(num){
      const val = Math.floor((num/22.5)+0.5);
      const arr = ["Ø´Ù…Ø§Ù„","Ø´Ù…Ø§Ù„â€ŒØ´Ø±Ù‚","Ø´Ø±Ù‚","Ø¬Ù†ÙˆØ¨â€ŒØ´Ø±Ù‚","Ø¬Ù†ÙˆØ¨","Ø¬Ù†ÙˆØ¨â€ŒØºØ±Ø¨","ØºØ±Ø¨","Ø´Ù…Ø§Ù„â€ŒØºØ±Ø¨"];
      return arr[(val % 8)];
    }

    async function fetchWeather(lat, lon, name){
      try{
        setStatus('Ø¯Ø± Ø­Ø§Ù„ ÙˆØ§Ú©Ø´ÛŒ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù‡ÙˆØ§...');
        weatherUI.style.display='none';
        coordsEl.textContent = `${lat.toFixed(3)}, ${lon.toFixed(3)}`;

        // Open-Meteo current weather
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,relativehumidity_2m,pressure_msl,windspeed_10m,winddirection_10m&timezone=auto`;
        const res = await fetch(url);
        if(!res.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø² Open-Meteo');
        const data = await res.json();
        lastResponse = data;

        if(!data.current_weather) throw new Error('Ø¯Ø§Ø¯Ù‡Ù” Current Weather ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯');

        const cw = data.current_weather;
        const w = mapWeather(cw.weathercode);

        iconEl.textContent = w.icon;
        tempEl.textContent = `${cw.temperature.toFixed(1)} Â°C`;
        descEl.textContent = `${w.text} â€” Ú©Ø¯: ${cw.weathercode}`;
        placeEl.textContent = name || `Ù…Ø®ØªØµØ§Øª: ${lat.toFixed(2)}, ${lon.toFixed(2)}`;
        windEl.textContent = `${cw.windspeed} m/s`;
        windDirEl.textContent = `${degToCompass(cw.winddirection)} (${cw.winddirection}Â°)`;
        pressureEl.textContent = data.hourly && data.hourly.pressure_msl && data.hourly.pressure_msl.length? `${data.hourly.pressure_msl[0]} hPa` : 'â€”';
        timeEl.textContent = cw.time;

        weatherUI.style.display='block';
        setStatus('Ø¨Ù‡â€ŒØ±ÙˆØ² Ø´Ø¯.');
        debugCard.style.display='none';
        lastPosition = {lat, lon, name};
      }catch(err){
        console.error(err);
        setStatus('Ø®Ø·Ø§: '+err.message, true);
        debugCard.style.display='block';
        debugPre.textContent = (err.stack || err.message || String(err));
      }
    }

    async function geocodeAndFetch(query){
      try{
        if(!query) { setStatus('Ù„Ø·ÙØ§ Ù†Ø§Ù… Ø´Ù‡Ø± Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.', true); return; }
        setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø¬Ø³ØªØ¬ÙˆÛŒ Ø´Ù‡Ø±...');
        const geourl = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(query)}&count=5&language=fa`;
        const gres = await fetch(geourl);
        if(!gres.ok) throw new Error('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ú©Ø§Ù†');
        const gdata = await gres.json();
        if(!gdata.results || gdata.results.length===0) { setStatus('Ù…Ú©Ø§Ù†ÛŒ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯.', true); return; }
        const top = gdata.results[0];
        const pretty = `${top.name}${top.admin1?(', '+top.admin1):''}${top.country?(', '+top.country):''}`;
        await fetchWeather(top.latitude, top.longitude, pretty);
      }catch(err){
        console.error(err);
        setStatus('Ø®Ø·Ø§ Ø¯Ø± Ø¬Ø³ØªØ¬Ùˆ: '+err.message, true);
      }
    }

    searchBtn.addEventListener('click', ()=> geocodeAndFetch(qInput.value.trim()));
    qInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter') geocodeAndFetch(qInput.value.trim()); });
    refreshBtn.addEventListener('click', ()=>{
      if(lastPosition) fetchWeather(lastPosition.lat, lastPosition.lon, lastPosition.name);
      else setStatus('Ø§Ø¨ØªØ¯Ø§ Ø´Ù‡Ø±ÛŒ Ø±Ø§ Ø¬Ø³ØªØ¬Ùˆ ÛŒØ§ Ø§Ø² Ù„ÙˆÚ©ÛŒØ´Ù† Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.', true);
    });

    locBtn.addEventListener('click', ()=>{
      if(!navigator.geolocation) { setStatus('Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ø§Ø² Geolocation Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ù†Ù…ÛŒâ€ŒÚ©Ù†Ø¯.', true); return; }
      setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø¯Ø±ÛŒØ§ÙØª Ù…ÙˆÙ‚Ø¹ÛŒØª...');
      navigator.geolocation.getCurrentPosition(async (pos)=>{
        const lat = pos.coords.latitude;
        const lon = pos.coords.longitude;
        // try to reverse geocode name using Open-Meteo geocoding reverse (not necessary but helpful)
        try{
          const rev = await fetch(`https://geocoding-api.open-meteo.com/v1/reverse?latitude=${lat}&longitude=${lon}&language=fa`);
          let name = '';
          if(rev.ok){
            const rj = await rev.json();
            if(rj && rj.name) name = `${rj.name}${rj.admin1?(', '+rj.admin1):''}${rj.country?(', '+rj.country):''}`;
          }
          await fetchWeather(lat, lon, name||'Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´Ù…Ø§');
        }catch(e){
          await fetchWeather(lat, lon, 'Ù…ÙˆÙ‚Ø¹ÛŒØª Ø´Ù…Ø§');
        }
      }, (err)=>{
        setStatus('Ø®Ø·Ø§ Ø¯Ø± Ø®ÙˆØ§Ù†Ø¯Ù† Ù„ÙˆÚ©ÛŒØ´Ù†: '+err.message, true);
      }, {enableHighAccuracy:true, timeout:10000});
    });

    // small UX: autosuggest using geocoding (lite)
    let suggestTimeout = null;
    qInput.addEventListener('input', ()=>{
      if(suggestTimeout) clearTimeout(suggestTimeout);
      suggestTimeout = setTimeout(async ()=>{
        const v = qInput.value.trim(); if(!v) return;
        try{
          const url = `https://geocoding-api.open-meteo.com/v1/search?name=${encodeURIComponent(v)}&count=5&language=fa`;
          const r = await fetch(url);
          if(!r.ok) return;
          const j = await r.json();
          // simple: if exact match returned first, do nothing; we won't render a dropdown to keep UI simple
        }catch(e){ /* ignore */ }
      }, 400);
    });

    // Optional: keyboard shortcut Ctrl+K to focus search
    window.addEventListener('keydown', (e)=>{ if((e.ctrlKey||e.metaKey) && e.key.toLowerCase()==='k'){ e.preventDefault(); qInput.focus(); qInput.select(); } });

  </script>
</body>
</html>